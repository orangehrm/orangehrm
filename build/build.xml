<?xml version="1.0" ?>
<!--
/**
 * OrangeHRM is a comprehensive Human Resource Management (HRM) System that captures
 * all the essential functionalities required for any enterprise.
 * Copyright (C) 2006 OrangeHRM Inc., http://www.orangehrm.com
 *
 * OrangeHRM is free software; you can redistribute it and/or modify it under the terms of
 * the GNU General Public License as published by the Free Software Foundation; either
 * version 2 of the License, or (at your option) any later version.
 *
 * OrangeHRM is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program;
 * if not, write to the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 * Boston, MA  02110-1301, USA
 *
 * @copyright 2006 OrangeHRM Inc., http://www.orangehrm.com
 */
-->
<project name="OrangeHRM" basedir="." default="dist">

  <property name="version" value="5.0"/>
  <property name="package.name" value="orangehrm-${version}"/>
  <resolvepath propertyName="project.dir" file=".."/>
  <resolvepath propertyName="dist.dir" file="dist"/>
  <property name="package.dir" value="${dist.dir}/${package.name}"/>
  <property name="reports.dir" value="${project.basedir}/reports"/>
  <property name="test.reports.dir" value="${reports.dir}/tests"/>
  <property name="test.coverage.dir" value="${reports.dir}/coverage"/>
  <property name="apidocs.dir" value="${dist.dir}/apidocs"/>
  <property name="xampp.dir" value="../../xampp"/>

  <exec command="git rev-list --tags --max-count=1" dir="${project.dir}" checkreturn="false"
        outputProperty="git.revision"/>
  <property name="base.name" value="${package.name}.${git.revision}"/>

  <target name="prepare">
    <echo msg="Preparing build..."/>
    <mkdir dir="${dist.dir}"/>
    <mkdir dir="${package.dir}"/>
    <mkdir dir="${reports.dir}"/>
    <mkdir dir="${test.reports.dir}"/>
    <mkdir dir="${test.coverage.dir}"/>
    <mkdir dir="${test.coverage.dir}/src"/>
    <mkdir dir="${test.coverage.dir}/lib"/>
    <mkdir dir="${apidocs.dir}"/>
    <touch file="release-revision-${git.revision}.txt"/>
  </target>

  <target name="deps.5x">
    <exec command="composer install" dir="${project.dir}/src" checkreturn="false" passthru="true"/>
    <exec command="composer dump-autoload -o" dir="${project.dir}/src" checkreturn="false" passthru="true"/>
    <exec command="yarn install" dir="${project.dir}/src/client" checkreturn="false" passthru="true"/>
  </target>

  <target name="build.client">
    <exec command="yarn build" dir="${project.dir}/src/client" checkreturn="false" passthru="true"/>
  </target>

  <target name="build" depends="prepare,clean">
    <echo>Copying files...</echo>
    <copy todir="${package.dir}" includeemptydirs="true">
      <fileset dir="${project.dir}">
        <include name="**"/>
        <include name="**/*.htaccess"/>
        <include name="build/build"/>
        <exclude name="build/dist/**"/>
        <exclude name="build/reports/**"/>
        <exclude name="build/report-styles/**"/>
        <exclude name="build/build.xml"/>
        <exclude name="build/phing-latest.phar"/>
        <exclude name=".github/**"/>
        <exclude name="INSTALL.html"/>
        <exclude name="Dockerfile"/>
        <exclude name="devTools/**"/>
        <exclude name="lib/confs/Conf.php"/>
        <exclude name="lib/confs/cryptokeys/key.ohrm"/>
        <exclude name="orangehrm-quick-start-guide.html"/>
        <exclude name="src/test/**"/>

        <exclude name="src/plugins/orangehrmAdminPlugin/lib/**"/>
        <exclude name="src/plugins/orangehrmAuthenticationPlugin/lib/**"/>
        <exclude name="src/plugins/orangehrmCoreOAuthPlugin/lib/**"/>
        <exclude name="src/plugins/orangehrmCorePlugin/lib/**"/>
        <exclude name="src/plugins/orangehrmPimPlugin/lib/**"/>

        <exclude name="src/plugins/orangehrmAttendancePlugin/lib"/>
        <exclude name="src/plugins/orangehrmBuzzPlugin/lib"/>
        <exclude name="src/plugins/orangehrmCoreWebServicePlugin/**"/>
        <exclude name="src/plugins/orangehrmCorporateBrandingPlugin/lib"/>
        <exclude name="src/plugins/orangehrmCorporateDirectoryPlugin/lib"/>
        <exclude name="src/plugins/orangehrmDashboardPlugin/lib"/>
        <exclude name="src/plugins/orangehrmMaintenancePlugin/lib"/>
        <exclude name="src/plugins/orangehrmMarketPlacePlugin/lib"/>
        <exclude name="src/plugins/orangehrmOpenidAuthenticationPlugin/**"/>
        <exclude name="src/plugins/orangehrmPerformancePlugin/lib"/>
        <exclude name="src/plugins/orangehrmPerformanceTrackerPlugin/**"/>
        <exclude name="src/plugins/orangehrmRecruitmentPlugin/lib"/>
        <exclude name="src/plugins/orangehrmRESTPlugin/**"/>

        <!-- 5.x related -->
        <exclude name="src/client/node_modules/**"/>
        <exclude name="src/client/.yarn/cache/**"/>

        <exclude name="installer/client/node_modules/**"/>
        <exclude name="installer/client/.yarn/cache/**"/>
      </fileset>
    </copy>

    <!-- done this way to avoid some quirks in phing behavior -->
    <delete includeemptydirs="true" failonerror="false" dir="${package.dir}/src/log"/>
    <delete includeemptydirs="true" failonerror="false" dir="${package.dir}/src/cache"/>
    <mkdir dir="${package.dir}/src/cache"/>
    <mkdir dir="${package.dir}/src/log"/>

    <delete includeemptydirs="true" failonerror="false" dir="${package.dir}/upgrader/log"/>
    <delete includeemptydirs="true" failonerror="false" dir="${package.dir}/upgrader/cache"/>

    <copy todir="${dist.dir}">
      <fileset dir="${project.dir}">
        <include name="orangehrm-quick-start-guide.html"/>
        <include name="logo.png"/>
      </fileset>
    </copy>
  </target>

  <target name="dist" depends="build">
    <echo message="Creating archives ..."/>

    <zip destfile="${dist.dir}/${base.name}.zip" ignoreLinks="true">
      <fileset dir="${dist.dir}">
        <include name="${package.name}/**"/>
        <include name="orangehrm-quick-start-guide.html"/>
        <include name="logo.png"/>
        <exclude name="*.zip"/>
        <exclude name="*.tar.gz"/>
        <exclude name="apidocs"/>
      </fileset>
    </zip>
    <tar destfile="${dist.dir}/${base.name}.tar.gz" compression="gzip">
      <fileset dir="${dist.dir}">
        <include name="${package.name}/**"/>
        <include name="orangehrm-quick-start-guide.html"/>
        <include name="logo.png"/>
        <exclude name="*.zip"/>
        <exclude name="*.tar.gz"/>
        <exclude name="apidocs"/>
      </fileset>
    </tar>
  </target>

  <fileset dir="./" id="deleteFiles">
    <include name="release-revision-*.txt"/>
  </fileset>

  <target name="clean">
    <echo msg="Cleaning up..."/>
    <delete dir="${dist.dir}"/>
    <delete dir="${reports.dir}"/>
    <delete>
      <fileset refid="deleteFiles"/>
    </delete>
  </target>
</project>
